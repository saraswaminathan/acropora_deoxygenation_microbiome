---
title: "2_HostAndSymbiontResponse_v2"
author: "Sara Devi Swaminathan"
date: "`r Sys.Date()`"
output: html_document
toc: true
toc_float: true
number_sections: true
---
# Table of Contents {#table-of-contents}

## Setup: working directory and packages

Load libraries and set working directory

```{r setup}
#Load necessary libraries
library(rcompanion) #plotting histograms
library(car)  #qqplot
library(readxl)
library(splitstackshape)
library(lubridate)
library(tidyverse)
library(brms)
library(parallel)
library(ggmcmc)
library(bayestestR)
library(tidybayes)
library(reshape)
library(bayesplot)
```


## set colors for plotting

```{r}
mytheme <- theme_classic() + 
  theme(text = element_text(size=15)) +
  theme(axis.text.x = element_text(size=15,colour="black"), 
        axis.text.y =   element_text(size=15,colour="black")) +
  theme(plot.margin = unit(c(5.5,5.5,5.5,15), "pt")) +
  theme(panel.border = element_rect(colour = "black", 
                                    fill=NA,size=1)) +
  theme(axis.line = element_line(size = 0))
plot.col.treat<-c("0.5" = "#F18D34", "2" = "#F5C75D", "4" =  "#E5EF99", "6" =  "#A5DEDE")


logit <- function(mu){
  logit.mu <- log(mu/(1-mu))
}
```


## Load data and format

```{r}
# all non-microbial response variables stored in Acer2_forR.xlsx
physData<-read_xlsx("data/Acer2_forR.xlsx") %>%
cSplit("Date","-")%>% #break apart date based on the slash
dplyr::rename(Year=Date_1, Month=Date_2, Day=Date_3) %>% #rename split columns Month, Day, and Year
mutate(Date = as.Date(mdy(paste(Month,Day,Year)))) %>%
  mutate(DayID = as.factor(ifelse(Day %in% c(16, 17, 18), 1, 
                        ifelse(Day==19, 2,
                               ifelse(Day==20, 3,
                                      ifelse(Day== 21, 4, 
                                           ifelse(Day==22, 5, NA))))))) %>%
  mutate(trtNumeric = as.numeric(Treatment), 
         Treatment = factor(Treatment, levels = c("6", "4", "2", "0.5")), # This order so that the "intercept level is normoxia (6.0)
         trtReverseOrder = factor(Treatment, levels = c("0.5", "2", "4", "6")), #reverse order for plotting
         Geno = factor(Genotype, order = FALSE), 
         Tank = factor(Tank, order = FALSE), 
         FragIDUnique = factor(FragIDUnique, order = FALSE),
         origin_site = ifelse(origin_site == "MUN", "inshore", "offshore"),
        origin_site=factor(origin_site, levels = c("offshore", "inshore")), 
        timepoint = as.factor(timepoint), 
        YII_PAM = as.numeric(YII_PAM), 
        F0_PAM = as.numeric(F0_PAM))
```

### dataframe for PAM data visualization and models
```{r}
PAM <-  physData%>%
  mutate(YII_PAM = ifelse(notes %in% c("removed"), NA, YII_PAM), # column called YII_PAM has NAs if frag died
F0_PAM = ifelse(notes %in% c("removed"), NA, F0_PAM))%>% # column called YII_PAM has NAs when frag was no longer in experiment
  filter(F0_PAM >= 250) #filter PAM data just to valid readings (>200 F0)

#split into two PAM timepoint datasets that will be analyzed separately
#dawn timepoint
dawn<-PAM%>%
  filter(timepoint=="dawn")
```

### dataframe for tissue retention visualization and models
```{r}
TL<-physData %>%
  filter(timepoint=="peak") %>% # tissue loss was only recorded at the peak timepoint
  mutate(propTissueRemaining = 1-propTL)%>% 
  mutate(presenceTL=ifelse(propTL > 0, 1, 0))

TL_prevDayTR <- TL %>%
  select(FragIDUnique, Day, Tank, DayID, origin_site, Geno, trtNumeric, Treatment, propTissueRemaining)%>%
  arrange(FragIDUnique)%>%
  group_by(FragIDUnique)%>%
  mutate(previousDay = lag(propTissueRemaining, order_by = Day))%>%
  arrange(FragIDUnique, Day)%>%
  filter(!Day == 16)%>%
  mutate(logitPrevDay = logit(previousDay))%>%
  ungroup
```

### dataframe for Symbiodiniaceae data visualization and models

```{r}
zoox<-physData %>%
  filter(timepoint == "peak") %>%
  filter(DayID == 5)%>%
  mutate(SA = ifelse(SA==0,.00001, SA), # so we don't divide by 0 and get NaN. 0s are in place for corals that died before experiment ended and were not blasted
         zooxInteger = as.integer(Zoox),
         zooxTotal = Zoox*SA,
         propTissueRemaining = 1-propTL,
        zooxNorm = zooxTotal*propTissueRemaining, 
        zooxNorm2 = (SA*propTissueRemaining)*Zoox)

ggplot(zoox)+
  geom_point(aes(x = zooxNorm, y = zooxNorm2))

zooxNoDead <- zoox%>%
  filter(Zoox>0)
```


### dataframe for survivorship data visualization and models
```{r}
#######################SURVIVORSHIP DATAFRAMES

Surv <- TL%>%
  mutate(surv = ifelse(propTL==1, 0, 1),
         mort = ifelse(surv == 1,0,1))
```

##  Data visualization 
- Make custom theme for all plots

```{r}
mytheme <- theme_classic() + 
  theme(text = element_text(size=15)) +
  theme(axis.text.x = element_text(size=15,colour="black"), 
        axis.text.y =   element_text(size=15,colour="black")) +
  theme(plot.margin = unit(c(5.5,5.5,5.5,15), "pt")) +
  theme(panel.border = element_rect(colour = "black", 
                                    fill=NA,size=1)) +
  theme(axis.line = element_line(size = 0))

### Set color palette 
#plot.col.treat<-c("0.5" = "#AD0606", "2" = "#CA8F08", "4" =  "#A4CE30", "6" =  "#A9E0A3")
plot.col.treat<-c("0.5" = "#F18D34", "2" = "#F5C75D", "4" =  "#E5EF99", "6" =  "#A5DEDE")
```

##  Set instructions for sampler

```{r}
n_cores <- detectCores() # this will determine how many cores your computer has so that it can use all of its processing power
n_chains <- 2 
n_iter <- 8000
n_warmup <- 2000
```


# I. Fv/Fm
- Dates of experiment: 10/19/2019- 10/22/2019
- AMBIENT measurements taken 17th and 18th

## PAM figures

```{r} 
### both sites - points and line graph
(dawnPamPlot08May23 <- dawn%>%
  ggplot(aes(color=Treatment))+ 
  geom_jitter(aes(x=DayID, y=YII_PAM), alpha = 0.9, width = 0.15)+
  geom_smooth(aes(x=DayID,y = YII_PAM,fill = Treatment,group = interaction(Treatment, origin_site)), method = "lm", alpha = 0.4)+
  mytheme+ 
  ylim(0.45,0.7)+
  labs(x="Day",y='Maximum Quantum Yield')+ 
  #ggtitle("Quantum Yield excluding 0's for already dead frags")+
  #theme(axis.text.x = element_text(size=10,colour="black", angle=45, hjust=1)) + 
  scale_colour_manual(values = plot.col.treat) + 
  scale_fill_manual(values = plot.col.treat) +
    mytheme+
  facet_wrap(~ origin_site))
ggsave(file = "fig/dawnPamPlot08May23.svg", plot = dawnPamPlot08May23, width = 7, height = 5)

### dawn, both sites together in one panel bc of no significance of site
(dawnPamPlot_noFacet <- dawn%>%
  ggplot(aes(color=Treatment))+ 
  geom_jitter(aes(x=DayID, y=YII_PAM), alpha = 0.9, width = 0.15)+
  geom_smooth(aes(x=DayID,y = YII_PAM,fill = Treatment,group = Treatment), method = "lm", alpha = 0.4)+
  mytheme+ 
  ylim(0.45,0.7)+
  labs(x="Day",y='Maximum Quantum Yield')+ 
  #ggtitle("Quantum Yield excluding 0's for already dead frags")+
  #theme(axis.text.x = element_text(size=10,colour="black", angle=45, hjust=1)) + 
  scale_colour_manual(values = plot.col.treat) + 
  scale_fill_manual(values = plot.col.treat) +
  mytheme)

### dawn, both sites together in one panel bc of no significance of site
(dawnPamPlot_noFacet <- dawn%>%
    mutate(DayNew = ifelse(DayID == "1", "0",
                         ifelse(DayID == "2", "1",
                                ifelse(DayID == "3", "2",
                                       ifelse(DayID == "4", "3",
                                              ifelse(DayID == "5", "4", NA))))))%>%
  ggplot()+ 
    geom_boxplot(aes(x=DayNew,y = YII_PAM,color = Treatment), size = 1, alpha = 0.5)+
  geom_jitter(aes(x=DayNew, y=YII_PAM, color = Treatment), position = position_jitterdodge(jitter.width = NULL,
  jitter.height = 0,
  dodge.width = 0.75,
  seed = NA), size = 1.5)+
  mytheme+ 
  ylim(0.45,0.7)+
  labs(x="Day",y='Maximum Quantum Yield')+ 
  #ggtitle("Quantum Yield excluding 0's for already dead frags")+
  #theme(axis.text.x = element_text(size=10,colour="black", angle=45, hjust=1)) + 
  scale_colour_manual(values = plot.col.treat) + 
  scale_fill_manual(values = plot.col.treat) +
  mytheme)

ggsave(file = "fig/dawnPamPlot_29Nov23.svg", plot = dawnPamPlot_noFacet, width = 7, height = 5)

```

## Visualize relationships

```{r}
hist(dawn$YII_PAM) # use beta distribution 
# plot relationships

dawn%>%
  ggplot(aes(x = DayID, y = YII_PAM, color = Treatment))+
  geom_smooth(aes(group = Treatment),method = "lm")+
  facet_wrap(~origin_site)

dawn%>%
  ggplot(aes(x = Day, y = YII_PAM, color = origin_site))+
  geom_smooth( method = "lm")+
  facet_wrap(~Treatment)
```

## Fv/Fm models

```{r}

# full model
pamDawn_mod_Phi <- bf(YII_PAM ~ 1  + Treatment +  Day + origin_site + origin_site*Treatment +  (1|FragIDUnique) , 
                    phi ~ 1  + Treatment +  Day + origin_site + origin_site*Treatment + (1|FragIDUnique) , 
                    family =  Beta(link = "logit", link_phi = "log"))

# with non-significant variables removed
pamDawn_mod_Phi2 <- bf(YII_PAM ~ 1  + Treatment +  Day + origin_site +   (1|FragIDUnique) , 
                    phi ~ 1  + Treatment +  Day + origin_site +  (1|FragIDUnique) , 
                    family =  Beta(link = "logit", link_phi = "log"))

# with non-significant variables removed
pamDawn_mod_Phi3 <- bf(YII_PAM ~ 1  + Treatment +  Day +   (1|FragIDUnique) , 
                    phi ~ 1  + Treatment +  Day + (1|FragIDUnique) , 
                    family =  Beta(link = "logit", link_phi = "log"))

# full model
pamDawn_mod_Phi4 <- bf(YII_PAM ~ 1  + Treatment +  DayID + origin_site + origin_site*Treatment +  (1|FragIDUnique) , 
                    phi ~ 1  + Treatment +  DayID + origin_site + origin_site*Treatment + (1|FragIDUnique) , 
                    family =  Beta(link = "logit", link_phi = "log"))

# full model
pamDawn_mod_Phi5 <- bf(YII_PAM ~ 1  + Treatment +  DayID + origin_site +  (1|FragIDUnique) , 
                    phi ~ 1  + Treatment +  DayID + origin_site + (1|FragIDUnique) , 
                    family =  Beta(link = "logit", link_phi = "log"))

# full model
pamDawn_mod_Phi6 <- bf(YII_PAM ~ 1  + Treatment +  DayID +  (1|FragIDUnique) , 
                    phi ~ 1  + Treatment +  DayID +  (1|FragIDUnique) , 
                    family =  Beta(link = "logit", link_phi = "log"))

##### Get priors

get_prior(pamDawn_mod_Phi, data = dawn) 

##### Set priors
pamDawn_mean <- dawn %>%
  dplyr::group_by(FragIDUnique) %>%
  dplyr::summarize(meanYield = mean(YII_PAM)) %>%
  mutate(logitMeanYield = logit(meanYield))

print(paste("The logit-transformed propSusc intercept is", round(pamDawn_mean[1,3], 2)))
# "The logit-transformed pamDawn intercept is 0.77"

pamDawn_prior <- c(prior(normal(0.77, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),
                prior(exponential(1), class = "sd"),
                prior(normal(0.77, 1), class = "Intercept", dpar = "phi"),
                prior(normal(0, 1), class = "b", dpar = "phi"),
                prior(exponential(1), class = "sd", dpar = "phi"))
                          

pamDawn_brm_Phi <- brm(pamDawn_mod_Phi,
               data = dawn,
               prior = pamDawn_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               warmup = n_warmup)

pamDawn_brm_Phi2 <- brm(pamDawn_mod_Phi2,
               data = dawn,
               prior = pamDawn_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               warmup = n_warmup)


pamDawn_brm_Phi3 <- brm(pamDawn_mod_Phi3,
               data = dawn,
               prior = pamDawn_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               warmup = n_warmup)

pamDawn_brm_Phi4 <- brm(pamDawn_mod_Phi4,
               data = dawn,
               prior = pamDawn_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               warmup = n_warmup)

pamDawn_brm_Phi5 <- brm(pamDawn_mod_Phi5,
               data = dawn,
               prior = pamDawn_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               warmup = n_warmup)

pamDawn_brm_Phi6 <- brm(pamDawn_mod_Phi6,
               data = dawn,
               prior = pamDawn_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               warmup = n_warmup)

### SAVE THE BEST MODEL
saveRDS(pamDawn_brm_Phi6, "model outputs/pamDawn_brm_Phi6.RDS")
#pamDawn_brm_Phi6<-readRDS("model outputs/pamDawn_brm_Phi6.RDS")


pamDawn_brm_Phi
describe_posterior(pamDawn_brm_Phi, ci = 0.65)
describe_posterior(pamDawn_brm_Phi, ci = 0.95)

pamDawn_brm_Phi2
describe_posterior(pamDawn_brm_Phi2, ci = 0.65)
describe_posterior(pamDawn_brm_Phi2, ci = 0.95)

pamDawn_brm_Phi3
describe_posterior(pamDawn_brm_Phi3, ci = 0.65)
describe_posterior(pamDawn_brm_Phi3, ci = 0.95)

pamDawn_brm_Phi4
describe_posterior(pamDawn_brm_Phi4, ci = 0.65)
describe_posterior(pamDawn_brm_Phi4, ci = 0.95)

pamDawn_brm_Phi5
describe_posterior(pamDawn_brm_Phi5, ci = 0.65)
describe_posterior(pamDawn_brm_Phi5, ci = 0.95)

pamDawn_brm_Phi6
describe_posterior(pamDawn_brm_Phi6, ci = 0.65)
describe_posterior(pamDawn_brm_Phi6, ci = 0.95)

model_weights(pamDawn_brm_Phi, pamDawn_brm_Phi2, pamDawn_brm_Phi3, weights = "loo") #compare all models where day is continuous - 3 is best (no site or interaction)
model_weights(pamDawn_brm_Phi4, pamDawn_brm_Phi5, pamDawn_brm_Phi6, weights = "loo") #compare all models where day is categorical - 6 is best (no site or interaction)
model_weights(pamDawn_brm_Phi3, pamDawn_brm_Phi6, weights = "loo") # compare best continuous vs. best categorical - 6 is best (categorical)

model_weights(pamDawn_brm_Phi, pamDawn_brm_Phi2, pamDawn_brm_Phi3, weights = "waic") #compare all models where day is continuous - 3 is best (no site or interaction)
model_weights(pamDawn_brm_Phi4, pamDawn_brm_Phi5, pamDawn_brm_Phi6, weights = "waic") #compare all models where day is categorical - 6 is best (no site or interaction)
model_weights(pamDawn_brm_Phi3, pamDawn_brm_Phi6, weights = "waic") # compare best continuous vs. best categorical - 6 is best (categorical)


pp_check(pamDawn_brm_Phi3, ndraws = 100)
pp_check(pamDawn_brm_Phi6, ndraws = 100)

pp_check(pamDawn_brm_Phi3, type = "dens_overlay_grouped", group = "Treatment", ndraws = 100)
pp_check(pamDawn_brm_Phi6, type = "dens_overlay_grouped", group = "Treatment", ndraws = 100)

pp_check(pamDawn_brm_Phi3, type = "dens_overlay_grouped", group = "Day", ndraws = 100)
pp_check(pamDawn_brm_Phi6, type = "dens_overlay_grouped", group = "DayID", ndraws = 100) # looks slightly better

pp_check(pamDawn_brm_Phi3,type = "loo_pit_overlay", ndraws = 100)
pp_check(pamDawn_brm_Phi6,type = "loo_pit_overlay", ndraws = 100) #this one looks slightly better

bayes_R2(pamDawn_brm_Phi3) #0.40
bayes_R2(pamDawn_brm_Phi6) #0.43

loo(pamDawn_brm_Phi) #3.8% > 0.7
loo(pamDawn_brm_Phi2) # 4.5% > 0.7
loo(pamDawn_brm_Phi3) # 3.2% > 0.7
loo(pamDawn_brm_Phi4) #8.5% > 0.7
loo(pamDawn_brm_Phi5) # 8.3% > 0.7
loo(pamDawn_brm_Phi6) #8.9% > 0.7

loo<- loo(pamDawn_brm_Phi6) 
loo::pareto_k_ids(loo, threshold = 0.7)

plot(loo,
  diagnostic = c("k"),
  label_points = FALSE,
  main = "PSIS diagnostic plot")

conditional_effects(pamDawn_brm_Phi6)
```

## Posterior plots

```{r}
# standardized effect size estimates
#-Get posterior draws for all parameter estimates-#
posterior_draws_pam <- pamDawn_brm_Phi6 %>%
 posterior_samples()%>%
 dplyr::select(-contains(c('cor', 'lp', 'Intercept', 'phi'))) %>%
  melt()%>%
  as_tibble()%>%
   mutate(Effect = ifelse(variable == "b_Treatment4", "4.0 mg/L DO", 
                         ifelse(variable == "b_Treatment2", "2.0 mg/L DO", 
                                ifelse(variable == "b_Treatment0.5", "0.5 mg/L DO", 
                                       ifelse(variable == "b_DayID2", "Day 1", 
                                       ifelse(variable == "b_DayID3", "Day 2", 
                                              ifelse(variable == "b_DayID4", "Day 3", 
                                                     ifelse(variable == "b_DayID5", "Day 4", NA))))))))%>%
  mutate(Order = ifelse(Effect == "4.0 mg/L DO", 1, 
                       ifelse(Effect == "2.0 mg/L DO", 2, 
                              ifelse(Effect == "0.5 mg/L DO", 3, 
                                     ifelse(Effect == "Day 1", 4, 
                                            ifelse(Effect == "Day 2", 5,
                                            ifelse(Effect == "Day 3", 6, 
                                                   ifelse(Effect == "Day 4", 7, NA))))))))
colnames(posterior_draws_pam) <- c("effect", "effect_estimate", "Effect", "Order")


(posterior_draws_pam_plot <- posterior_draws_pam %>%
  ggplot(aes(x = effect_estimate, y = reorder(Effect, -Order))) +
  stat_halfeye()+
  geom_vline(xintercept = 0, size = 1.5, linetype = "dashed") +
  theme_bw(base_size = 16) +
  ylab("") +
  mytheme+
  coord_cartesian(c(-.2,.1))+
  xlab("Posterior effect size estimate"))

ggsave(file = "fig/pd_pam_28Nov23.svg", plot = posterior_draws_pam_plot, width = 7, height = 5)

```

## getting info for Table 2

```{r}
describe_posterior(pamDawn_brm_Phi6, ci = 0.65)
describe_posterior(pamDawn_brm_Phi6, ci = 0.95)
```

# II.  Symbiodiniaceae 

## Symbiodiniaceae figures

```{r,message=FALSE}
hist(zooxNoDead$zooxNorm)
hist(zooxNoDead$zooxNorm2)
hist(zoox$Zoox)

#### Zoox NORMALIZED BOX plot by site 
(acerZooxBoxplotNorm <- ggplot(zooxNoDead,aes(x=trtReverseOrder,y=zooxNorm,color=trtReverseOrder,group=trtReverseOrder, fill=trtReverseOrder))+ 
  geom_boxplot(aes(y=zooxNorm,x = trtReverseOrder), alpha = 0.5)+ 
    geom_point(aes(y=zooxNorm,x = trtReverseOrder), position = position_jitterdodge())+
  labs(x="Oxygen treatment",y='Symbiodinaceae density')+
  scale_colour_manual(values = plot.col.treat)+
  scale_fill_manual(values = plot.col.treat)+ 
  facet_wrap(~origin_site)+
    mytheme)

ggsave(file = "fig/acerZooxBoxplotNorm08May23.svg", plot = acerZooxBoxplotNorm, width = 7, height = 5)

(acerZooxBoxplotNorm_noFacet <- ggplot(zooxNoDead)+ 
  geom_boxplot(aes(y=log(zooxNorm),x = Treatment, color = Treatment), alpha = 0.9, size = 1)+ 
    geom_point(aes(y=log(zooxNorm),x = Treatment, color = Treatment), position = position_jitterdodge(),alpha = 0.9, size = 3)+
  labs(x="Oxygen treatment",y='Symbiodinaceae density')+
  scale_colour_manual(values = plot.col.treat)+
  scale_fill_manual(values = plot.col.treat)+ 
    mytheme)
ggsave(file = "fig/acerZooxBoxplotNorm_29Nov23.svg", plot = acerZooxBoxplotNorm_noFacet, width = 7, height = 5)
```

## Symbiodiniaceae models

```{r}
##################################################################################################################

# zoox_mod <- bf(zooxNorm ~ 1  + Treatment + origin_site + origin_site*Treatment + (1|Geno) + (1|Tank), 
#                #shape ~  1  + trtNumeric  + (1 |Geno) + (1 |Tank), 
#                family = Gamma(link = "log"))
zoox_mod_shape <- bf(zooxNorm ~ 1  + Treatment + origin_site + origin_site*Treatment + (1|Geno) + (1|Tank), 
                     shape ~  1  + Treatment + origin_site + origin_site*Treatment + (1|Geno) + (1|Tank), 
               family = Gamma(link = "log"))

zoox_mod_shape2 <- bf(zooxNorm ~ 1  + Treatment + origin_site + (1|Geno) + (1|Tank), 
                     shape ~  1  + Treatment + origin_site + (1|Geno) + (1|Tank), 
               family = Gamma(link = "log"))

zoox_mod_shape3 <- bf(zooxNorm ~ 1  + Treatment  + (1|Geno) + (1|Tank), 
                     shape ~  1  + Treatment  + (1|Geno) + (1|Tank), 
               family = Gamma(link = "log"))

##### Set priors
zoox_mean <-  zooxNoDead %>%
  dplyr::group_by(Geno) %>%
  dplyr::summarize(logmeanZoox = log(mean(zooxNorm)))


print(paste("The logit-transformed zoox intercept is", round(zoox_mean[1,2], 2)))
# "The logit-transformed pamDawn intercept is 17.3"


zoox_prior <- c(prior(normal(17.3, 2), class = "Intercept"),
                prior(normal(0, 1), class = "b"),
                prior(exponential(1), class = "sd"),
                prior(normal(17.3, 2), class = "Intercept", dpar = "shape"),
                prior(normal(0, 1), class = "b", dpar = "shape"))
                          
zoox_brm_shape <- brm(zoox_mod_shape,
               data = zooxNoDead,
               prior = zoox_prior,
               cores = n_cores,
               chains = n_chains,
               init = "0",
               iter = n_iter,
               warmup = n_warmup)
zoox_brm_shape2 <- brm(zoox_mod_shape2,
               data = zooxNoDead,
               prior = zoox_prior,
               cores = n_cores,
               chains = n_chains,
               init = "0",
               iter = n_iter,
               warmup = n_warmup)
zoox_brm_shape3 <- brm(zoox_mod_shape3,
               data = zooxNoDead,
               prior = zoox_prior,
               cores = n_cores,
               chains = n_chains,
               init = "0",
               iter = n_iter,
               warmup = n_warmup)

### SAVE THE BEST MODEL
saveRDS(zoox_brm_shape3, "model outputs/zoox_brm_shape3.RDS")
#zoox_brm_shape3<-readRDS("model outputs/zoox_brm_shape3.RDS")

model_weights(zoox_brm_shape, zoox_brm_shape2, zoox_brm_shape3, weights = "loo") #slightly better without site or site*treatment
model_weights(zoox_brm_shape, zoox_brm_shape2, zoox_brm_shape3, weights = "waic") #slightly better without site*treatment but with site

pp_check(zoox_brm_shape3, type = "dens_overlay",  ndraws = 100)

pp_check(zoox_brm_shape3, type = "dens_overlay_grouped", group = "Treatment", ndraws = 100)

pp_check(zoox_brm_shape2,type = "loo_pit_overlay", ndraws = 100)
pp_check(zoox_brm_shape3,type = "loo_pit_overlay", ndraws = 100) # better

bayes_R2(zoox_brm_shape2) #0.32
bayes_R2(zoox_brm_shape3) #0.31

loo(zoox_brm_shape2)
loo(zoox_brm_shape3) # better without site or site*trt

conditional_effects(zoox_brm_shape3)
```

## Posterior plots

```{r}
# standardized effect size estimates
#-Get posterior draws for all parameter estimates-#
posterior_draws_zoox <- zoox_brm_shape3 %>%
 posterior_samples()%>%
  dplyr::select(-contains(c('cor', 'phi', 'sd', 'lp', 'shape', 'Geno', 'Tank', 'Intercept'))) %>%
  melt()%>%
  as_tibble()%>%
   mutate(Effect = ifelse(variable == "b_Treatment4", "4.0 mg/L DO", 
                         ifelse(variable == "b_Treatment2", "2.0 mg/L DO", 
                                ifelse(variable == "b_Treatment0.5", "0.5 mg/L DO", NA))))%>%
  mutate(Order = ifelse(Effect == "4.0 mg/L DO", 1, 
                       ifelse(Effect == "2.0 mg/L DO", 2, 
                              ifelse(Effect == "0.5 mg/L DO", 3, NA))))
colnames(posterior_draws_zoox) <- c("effect", "effect_estimate", "Effect", "Order")


(posterior_draws_zoox_plot <- posterior_draws_zoox %>%
  ggplot(aes(x = effect_estimate, y = reorder(Effect, -Order))) +
  stat_halfeye()+
  geom_vline(xintercept = 0, size = 1.5, linetype = "dashed") +
  theme_bw(base_size = 16) +
  ylab("") +
  mytheme+
  coord_cartesian(c(-1.5,.5))+
  xlab("Posterior effect size estimate"))

ggsave(file = "fig/pd_zoox_28Nov23.svg", plot = posterior_draws_zoox_plot, width = 7, height = 5)
```

## getting info for Table 2

```{r}
zoox_brm_shape2
describe_posterior(zoox_brm_shape3, ci = .65)
describe_posterior(zoox_brm_shape3, ci = .95)
zooxTable
```


# III. Tissue retention data

## Tissue retention figures

```{r}
# % fragment tissue loss by treatment and origin site
(TLplot <-TL%>%
ggplot(aes(x = Day, y = propTissueRemaining)) + 
    ylab("% tissue remaining") + 
    xlab("Day") +
    geom_jitter(aes(color = Treatment),  alpha = 0.9, width = 0.15)+
geom_smooth(aes(color = Treatment, fill = Treatment), method = "lm")+
   scale_fill_manual(values = plot.col.treat) + 
    coord_cartesian(ylim=c(0,1))+
   scale_color_manual(values = plot.col.treat) + 
   facet_wrap(facets = ~origin_site)+ 
   mytheme)

ggsave(file = "fig/TLplot.svg", plot = TLplot, width = 7, height = 5)

```

## Tissue retention models 

```{r}
##################################################################################################################
#Model that makes the most sense and tests our hypotheses
### using all the timepoints, and the logit-transformed value from the previous day as a predictor

zoibTR_mod <- bf(propTissueRemaining ~ 1  + Treatment + Day+ origin_site+ origin_site*Treatment +  (1|Tank) +  (1|Geno),
              phi ~ 1  + Treatment + Day+ origin_site+ origin_site*Treatment  + (1|Tank) +  (1|Geno) ,
              zoi ~ 1  + Treatment + Day+ origin_site+ origin_site*Treatment  + (1|Tank) +  (1|Geno) ,
              coi ~ 1  + Treatment + Day+ origin_site+ origin_site*Treatment  + (1|Tank) +  (1|Geno) ,
              family =  zero_one_inflated_beta(link = "logit", link_phi = "log"))

zoibTR_mod2 <- bf(propTissueRemaining ~ 1  + Treatment + Day+ origin_site +   (1|Tank) +  (1|Geno) ,
              phi ~ 1  + Treatment + Day+ origin_site+  (1|Tank) +  (1|Geno) ,
              zoi ~ 1  + Treatment + Day+ origin_site+   (1|Tank) +  (1|Geno) ,
              coi ~ 1  + Treatment + Day+ origin_site+   (1|Tank) +  (1|Geno) ,
              family =  zero_one_inflated_beta(link = "logit", link_phi = "log"))

zoibTR_mod3 <- bf(propTissueRemaining ~ 1  + Treatment + Day+    (1|Tank) +  (1|Geno) ,
              phi ~ 1  + Treatment + Day+   (1|Tank) +  (1|Geno)  ,
              zoi ~ 1  + Treatment + Day+   (1|Tank) +  (1|Geno)  ,
              coi ~ 1  + Treatment + Day+  (1|Tank) +  (1|Geno)  ,
              family =  zero_one_inflated_beta(link = "logit", link_phi = "log"))

zoibTR_mod4 <- bf(propTissueRemaining ~ 1  + Treatment + DayID+ origin_site+ origin_site*Treatment +  (1|Tank) +  (1|Geno) ,
              phi ~ 1  + Treatment + DayID+ origin_site+ origin_site*Treatment  +  (1|Tank) +  (1|Geno) ,
              zoi ~ 1  + Treatment + DayID+ origin_site+ origin_site*Treatment  +  (1|Tank) +  (1|Geno)  ,
              coi ~ 1  + Treatment + DayID+ origin_site+ origin_site*Treatment  +  (1|Tank) +  (1|Geno) ,
              family =  zero_one_inflated_beta(link = "logit", link_phi = "log"))

zoibTR_mod5 <- bf(propTissueRemaining ~ 1  + Treatment + DayID+ origin_site +  (1|Tank) +  (1|Geno),
              phi ~ 1  + Treatment + DayID+ origin_site+  (1|Tank) +  (1|Geno) ,
              zoi ~ 1  + Treatment + DayID+ origin_site+   (1|Tank) +  (1|Geno) ,
              coi ~ 1  + Treatment + DayID+ origin_site+   (1|Tank) +  (1|Geno) ,
              family =  zero_one_inflated_beta(link = "logit", link_phi = "log"))

zoibTR_mod6 <- bf(propTissueRemaining ~ 1  + Treatment + DayID+    (1|Tank) +  (1|Geno) ,
              phi ~ 1  + Treatment + DayID+   (1|Tank) +  (1|Geno) ,
              zoi ~ 1  + Treatment + DayID+   (1|Tank) +  (1|Geno)  ,
              coi ~ 1  + Treatment + DayID+   (1|Tank) +  (1|Geno) ,
              family =  zero_one_inflated_beta(link = "logit", link_phi = "log"))

get_prior(zoibTR_mod, data = TL_prevDayTR)

##### Set priors
TR_mean <- TL_prevDayTR %>%
  filter(!is.na(propTissueRemaining))%>%
  dplyr::group_by(Geno) %>%
  dplyr::summarize(meanTR = mean(propTissueRemaining)) %>%
  mutate(logitmeanTR = logit(meanTR))


print(paste("The logit-transformed TR intercept is", round(TR_mean[1,3], 2)))
# "The logit-transformed TL intercept is 1.71"

zoibTR_prior<- c(prior(normal(1.71, 1), class = "Intercept"),
               prior(normal(0, 1), class = "b"),
              #prior(lkj(2), class = "cor"),
               #prior(logistic(0, 1), class = "Intercept", dpar = "zoi"),
               prior(normal(0, 1), class = "b", dpar = "zoi"),
               prior(exponential(1), class = "sd", dpar = "zoi"),
               #prior(logistic(0, 1), class = "Intercept", dpar = "coi"),
               prior(normal(0, 1), class = "b", dpar = "coi"),
               prior(exponential(1), class = "sd", dpar = "coi"),
               prior(normal(1.71, 1), class = "Intercept", dpar = "phi"),
               prior(normal(0, 1), class = "b", dpar = "phi"),
               prior(normal(0, 1), class = "sd", dpar = "phi"),
               prior(exponential(1), class = "sd"))

zoibTR_brm <- brm(zoibTR_mod,
               data = TL_prevDayTR,
               prior = zoibTR_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)
zoibTR_brm
zoibTR_brm2 <- brm(zoibTR_mod2,
               data = TL_prevDayTR,
               prior = zoibTR_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

zoibTR_brm3 <- brm(zoibTR_mod3,
               data = TL_prevDayTR,
               prior = zoibTR_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

zoibTR_brm4 <- brm(zoibTR_mod4,
               data = TL_prevDayTR,
               prior = zoibTR_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

zoibTR_brm5 <- brm(zoibTR_mod5,
               data = TL_prevDayTR,
               prior = zoibTR_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

zoibTR_brm6 <- brm(zoibTR_mod6,
               data = TL_prevDayTR,
               prior = zoibTR_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)
model_weights(zoibTR_brm, zoibTR_brm2, zoibTR_brm3, weights = "loo") #of Day continuous models, full model is best by far
model_weights(zoibTR_brm, zoibTR_brm2, zoibTR_brm3, weights = "waic") #of Day continuous models, full model is best by far
model_weights(zoibTR_brm4, zoibTR_brm5, zoibTR_brm6, weights = "loo") #of Day categorical models, full model is best by far
model_weights(zoibTR_brm4, zoibTR_brm5, zoibTR_brm6, weights = "waic") #of Day categorical models, full model is best by far
model_weights(zoibTR_brm, zoibTR_brm4, weights = "loo") #of both full models, Day continuous is best by far
model_weights(zoibTR_brm, zoibTR_brm4, weights = "waic") #of both full models, Day continuous is best by far

bayes_R2(zoibTR_brm) #.40
pp_check(zoibTR_brm, type = "dens_overlay",ndraws = 100)

pp_check(zoibTR_brm, type = "dens_overlay_grouped", group = "Treatment", ndraws = 100)
pp_check(zoibTR_brm, type = "dens_overlay_grouped", group = "origin_site", ndraws = 100)


loo(zoibTR_brm)
conditional_effects(zoibTR_brm)


############ALTERNATIVE TO LOO PIT - LOOKS GOOD
y <- posterior_predict(zoibTR_brm)*100
yrep_int <- sapply(data.frame(y), as.integer)
y_int <- as.integer(TL_prevDayTR$propTissueRemaining*100)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## Posterior plots
```{r}
#-Get posterior draws for all parameter estimates-#
posterior_draws_TR <- zoibTR_brm %>%
 posterior_samples()%>%
  dplyr::select(-contains(c('cor', 'phi', 'sd', 'lp', 'coi', 'zoi', 'Tank', 'Geno', 'Intercept' ))) %>%
  melt()%>%
  as_tibble()%>%
  mutate(Effect = ifelse(variable == "b_Treatment4", "4.0 mg/L DO", 
                         ifelse(variable == "b_Treatment2", "2.0 mg/L DO", 
                                ifelse(variable == "b_Treatment0.5", "0.5 mg/L DO", 
                                       ifelse(variable == "b_origin_siteinshore", "inshore site", 
                                               ifelse(variable == "b_Day", "Day", 
                                              ifelse(variable == "b_Treatment4:origin_siteinshore", "inshore * 4.0 mg/L", 
                                                     ifelse(variable == "b_Treatment2:origin_siteinshore", "inshore * 2.0 mg/L", 
                                                            ifelse(variable == "b_Treatment0.5:origin_siteinshore", "inshore * 0.5 mg/L", NA)))))))))%>%
  mutate(Order = ifelse(Effect == "4.0 mg/L DO", 1, 
                       ifelse(Effect == "2.0 mg/L DO", 2, 
                              ifelse(Effect == "0.5 mg/L DO", 3, 
                                     ifelse(Effect == "inshore site", 4, 
                                            ifelse(Effect == "Day", 5, 
                                            ifelse(Effect == "inshore * 4.0 mg/L", 6, 
                                                   ifelse(Effect == "inshore * 2.0 mg/L", 7, 
                                                          ifelse(Effect == "inshore * 0.5 mg/L", 8, NA)))))))))

colnames(posterior_draws_TR) <- c("effect", "effect_estimate", "Effect", "Order")

(posterior_draws_TR_plot <- posterior_draws_TR %>%
  ggplot(aes(x = effect_estimate, y = reorder(Effect, -Order))) +
  stat_halfeye()+
  geom_vline(xintercept = 0, size = 1.5, linetype = "dashed") +
  theme_bw(base_size = 16) +
  ylab("") +
  mytheme+
  coord_cartesian(c(-2,2))+
  xlab("Posterior effect size estimate"))

ggsave(file = "fig/pd_tissueRetention_28Nov23.svg", plot = posterior_draws_TR_plot, width = 7, height = 7)

```


## getting info for Table 2

```{r}
describe_posterior(zoibTR_brm, ci = 0.65)
describe_posterior(zoibTR_brm, ci = 0.95)
```

# IV. Survivorship data

```{r}
# dataframe for plotting
# % mortality by tank + day + Site + treatment
propSurvTrtSite<-TL %>%
  group_by(DayID, origin_site, Treatment) %>%
  mutate(dummy1 = 1,
         numFrags = sum(dummy1),
         mortality = ifelse(propTL>=0.95, 1, 
                            ifelse(propTL<.95,0, NA))) %>%
  summarise(propMort = sum(mortality)/numFrags)%>%
  unique()%>%
  mutate(propSurv=1-propMort)%>%
  mutate(propSurv = ifelse(DayID=="1", 1, propSurv))

```

### Survivorship figures

```{r}
(survPlot_tank<- ggplot(data = propSurvTrtSite, aes(x = DayID, y = propSurv)) + 
    ylab("% survivorship") + 
    xlab("Day") +
  #geom_line(aes(color = Treatment, group = interaction(Tank)), size = 2, alpha = 0.65) +
  geom_point(aes(color = Treatment)) +
  geom_smooth(aes(color = Treatment, fill = Treatment, group = Treatment), method = 'lm')+ 
  scale_fill_manual(values = plot.col.treat) + 
  scale_color_manual(values = plot.col.treat) + 
  facet_wrap(facets = vars(origin_site)) + 
  coord_cartesian(ylim = c(0,1))+
  mytheme)
ggsave(file = "fig/SurvTreatSitePlot.svg", plot = survPlot_tank, width = 7, height = 5)

(survPlot_tank<- ggplot(data = propSurvTankSite, aes(x = reorder(Treatment), y = propSurv)) + 
    ylab("% survivorship") + 
    xlab("Day") +
  #geom_line(aes(color = Treatment, group = interaction(Tank)), size = 2, alpha = 0.65) +
  geom_jitter(aes(color = Treatment)) +
  geom_boxplot(aes(color = Treatment, fill = Treatment), alpha = 0.65)+ 
  scale_fill_manual(values = plot.col.treat) + 
  scale_color_manual(values = plot.col.treat) + 
  facet_wrap(facets = vars(origin_site)) + 
  coord_cartesian(ylim = c(0,1))+
  mytheme)


```

## Survivorship models

```{r}

#define model
surv_mod <- bf(surv ~ 1  + Treatment  + Day + origin_site + Treatment*origin_site + (1|Geno)  + (1|Tank) , 
             family =  bernoulli(link = "logit"))

#define model
surv_mod2 <- bf(surv ~ 1  + Treatment  + Day + origin_site +   (1|Geno)  + (1|Tank) , 
             family =  bernoulli(link = "logit"))

#define model
surv_mod3 <- bf(surv ~ 1  + Treatment  + Day + (1|Geno)  + (1|Tank) , 
             family =  bernoulli(link = "logit"))

#define model
surv_mod4 <- bf(surv ~ 1  + Treatment  + DayID + origin_site + Treatment*origin_site + (1|Geno)  + (1|Tank) , 
             family =  bernoulli(link = "logit"))

#define model
surv_mod5 <- bf(surv ~ 1  + Treatment  + DayID + origin_site +  (1|Geno)  + (1|Tank) , 
             family =  bernoulli(link = "logit"))

#define model
surv_mod6 <- bf(surv ~ 1  + Treatment  + DayID +  (1|Geno)  + (1|Tank) , 
             family =  bernoulli(link = "logit"))


##### Set priors
surv_mean <- Surv %>%
  dplyr::group_by(Geno) %>%
  dplyr::summarize(meanSurv = mean(surv)) %>%
  mutate(logitmeanSurv = logit(meanSurv))

print(paste("The logit-transformed surv intercept is", round(surv_mean[1,3], 2)))
# 3.14

surv_prior <- c(prior(normal(3.14, 1), class = "Intercept"),
                prior(normal(0, 1), class = "b"),
                prior(exponential(2), class = "sd"))
                          
surv_brm <- brm(surv_mod,
               data = Surv,
               prior = surv_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

surv_brm2 <- brm(surv_mod2,
               data = Surv,
               prior = surv_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

surv_brm3 <- brm(surv_mod3,
               data = Surv,
               prior = surv_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

surv_brm4 <- brm(surv_mod4,
               data = Surv,
               prior = surv_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

surv_brm5 <- brm(surv_mod5,
               data = Surv,
               prior = surv_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

surv_brm6 <- brm(surv_mod6,
               data = Surv,
               prior = surv_prior,
               cores = n_cores,
               chains = n_chains,
               iter = n_iter,
               init = "0",
               warmup = n_warmup)

model_weights(surv_brm, surv_brm2, surv_brm3, weights = "loo") #of Day continuous models, full model is best by far
model_weights(surv_brm, surv_brm2, surv_brm3, weights = "waic") #of Day continuous models, full model is best by far
model_weights(surv_brm4, surv_brm5, surv_brm6, weights = "loo") #of Day categorical models, full model is best by far
model_weights(surv_brm4, surv_brm5, surv_brm6, weights = "waic") #of Day categorical models, full model is best by far
model_weights(surv_brm, surv_brm4, weights = "loo") #of both full models, Day continuous is best by far
model_weights(surv_brm, surv_brm4,  weights = "waic") #of both full models, Day continuous is best by far


bayes_R2(surv_brm) #.38
pp_check(surv_brm, type = "dens_overlay",ndraws = 100)

pp_check(surv_brm, type = "dens_overlay_grouped", group = "Treatment", ndraws = 100)
pp_check(surv_brm, type = "dens_overlay_grouped", group = "origin_site", ndraws = 100)
loo(surv_brm) #looks great
conditional_effects(surv_brm)

############ALTERNATIVE TO LOO PIT - LOOKS GOOD
y <- posterior_predict(surv_brm)*100
yrep_int <- sapply(data.frame(y), as.integer)
y_int <- as.integer(Surv$surv*100)
ppc_bars(y_int, yrep_int)
ppc_rootogram(y_int, yrep_int)
```

## posterior plots

```{r}
#-Get posterior draws for all parameter estimates-#
posterior_draws_surv <- surv_brm %>%
 posterior_samples()%>%
  dplyr::select(-contains(c( 'phi', 'sd', 'lp', 'Tank', 'Geno', 'Intercept'))) %>%
  melt()%>%
  as_tibble()%>%
   mutate(Effect = ifelse(variable == "b_Treatment4", "4.0 mg/L DO", 
                         ifelse(variable == "b_Treatment2", "2.0 mg/L DO", 
                                ifelse(variable == "b_Treatment0.5", "0.5 mg/L DO", 
                                       ifelse(variable == "b_Day", "Day", 
                                       ifelse(variable == "b_origin_siteinshore", "inshore site", 
                                              ifelse(variable == "b_Treatment4:origin_siteinshore", "inshore * 4.0 mg/L", 
                                                     ifelse(variable == "b_Treatment2:origin_siteinshore", "inshore * 2.0 mg/L", 
                                                            ifelse(variable == "b_Treatment0.5:origin_siteinshore", "inshore * 0.5 mg/L", NA)))))))))%>%
  mutate(Order = ifelse(Effect == "4.0 mg/L DO", 1, 
                       ifelse(Effect == "2.0 mg/L DO", 2, 
                              ifelse(Effect == "0.5 mg/L DO", 3, 
                                     ifelse(Effect == "inshore site", 4, 
                                            ifelse(Effect == "Day", 5,
                                            ifelse(Effect == "inshore * 4.0 mg/L", 6, 
                                                   ifelse(Effect == "inshore * 2.0 mg/L", 7, 
                                                          ifelse(Effect == "inshore * 0.5 mg/L", 8, NA)))))))))
colnames(posterior_draws_surv) <- c("effect", "effect_estimate", "Effect", "Order")


(posterior_draws_surv_plot <- posterior_draws_surv %>%
  ggplot(aes(x = effect_estimate, y = reorder(Effect, -Order))) +
  stat_halfeye()+
  geom_vline(xintercept = 0, size = 1.5, linetype = "dashed") +
  theme_bw(base_size = 16) +
  ylab("") +
  mytheme+
  coord_cartesian(c(-2.5,2.5))+
  xlab("Posterior effect size estimate"))

ggsave(file = "fig/pd_survivorship_28Nov23.svg", plot = posterior_draws_surv_plot, width = 7, height = 5)

```


## getting info for Table 2

```{r}
describe_posterior(surv_brm, ci = 0.95)
describe_posterior(surv_brm, ci = 0.65)
```